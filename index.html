<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
<!-- Default (desktop and everything else) -->
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- Mobile override (where supported) -->
<meta name="viewport"
      media="(max-width: 768px)"
      content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no">

  <title>NOCLIP - NKN Powered Telepresence</title>
  <link rel="stylesheet" href="style.css">

  <!-- NKN SDK (global window.nkn) -->
  <script src="https://unpkg.com/nkn-sdk@1.3.6/dist/nkn.min.js"></script>

  <!-- Leaflet for minimap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    (function () {
      function checkAndRemove() {
        var el = document.getElementById('VRButton');
        if (!el) return false;

        var txt = (el.textContent || "").trim().toUpperCase();
        if (txt === "VR NOT AVAILABLE" || txt.includes("VR NOT AVAILABLE") || txt === "VR NOT SUPPORTED" || txt.includes("VR NOT SUPPORTED") || txt === "WEBXR NOT AVAILABLE" || txt.includes("WEBXR NOT AVAILABLE")) {
          el.remove();
          return true;
        }
        return false;
      }

      // Run now or on DOM ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", checkAndRemove, { once: true });
      } else {
        checkAndRemove();
      }

      // Catch late-inserted buttons
      var mo = new MutationObserver(function (_, obs) {
        if (checkAndRemove()) obs.disconnect();
      });
      mo.observe(document.documentElement || document.body, { childList: true, subtree: true });
    })();
  </script>
  <!-- three.js import map -->
  <script type="importmap">
    {
      "imports": {
        "three"   : "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.min.js",
        "VRButton": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/VRButton.js",
        "Sky": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/objects/Sky.js",
        "XRControllerModelFactory": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/XRControllerModelFactory.js",
        "PointerLockControls": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/controls/PointerLockControls.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
        "nats.ws": "https://cdn.jsdelivr.net/npm/nats.ws@1.29.2/esm/nats.js"
      }
    }
  </script>
</head>

<body>
  <div id="toastHost" aria-live="polite" aria-atomic="false"></div>
  <div id="teleportToastHost" aria-live="polite" aria-atomic="true"></div>
  <div id="buildingHoverToast" class="building-toast" aria-live="polite" aria-atomic="true" role="status" hidden>
    <div class="building-toast-name" data-role="toast-name"></div>
    <div class="building-toast-address" data-role="toast-address">—</div>
  </div>
  <div id="perfHud" aria-live="polite" aria-expanded="false" role="button" tabindex="0" title="Open control center">
    <div class="hud-overlay" id="hudDetail">
      <div class="hud-topline">
        <div class="hud-compass" aria-hidden="true">
          <span class="hud-compass-needle" id="hudCompassNeedle"></span>
        </div>
        <div class="hud-metric-group">
          <div class="hud-metric">
            <span class="hud-metric-value" id="hudHeadingText">--°</span>
            <span class="hud-metric-label">Heading</span>
          </div>
          <div class="hud-metric">
            <span class="hud-metric-value" id="hudFps">60</span>
            <span class="hud-metric-label">FPS</span>
          </div>
          <div class="hud-metric">
            <span class="hud-metric-value" id="hudPeerCount">0</span>
            <span class="hud-metric-label">Peers</span>
          </div>
        </div>
        <div class="hud-clock">
          <div class="hud-clock-row">
            <span class="hud-clock-time mono" id="hudClockLocal">--:--:--</span>
            <span class="hud-clock-label">Local</span>
          </div>
          <div class="hud-clock-row">
            <span class="hud-clock-time mono" id="hudClockUtc">--:--:--</span>
            <span class="hud-clock-label">UTC</span>
          </div>
          <div class="hud-astro">
            <span class="hud-astro-item" id="hudSunInfo">Sun --° · --°</span>
            <span class="hud-astro-item" id="hudMoonInfo">Moon --° · --°</span>
          </div>
        </div>
      </div>

      <div class="hud-status-row">
        <div class="hud-status-chip" id="hudStatusNkn">
          <span class="hud-status-dot" id="hudStatusNknDot" aria-hidden="true"></span>
          <span class="hud-status-text" id="hudStatusNknLabel">NKN</span>
        </div>
        <div class="hud-status-chip" id="hudStatusTerrain">
          <span class="hud-status-dot" id="hudStatusTerrainDot" aria-hidden="true"></span>
          <span class="hud-status-text" id="hudStatusTerrainLabel">Terrain</span>
        </div>
        <div class="hud-status-chip" id="hudStatusSignal">
          <span class="hud-status-dot" id="hudStatusSigDot" aria-hidden="true"></span>
          <span class="hud-status-text" id="hudStatusSigLabel">Signal</span>
        </div>
      </div>

      <div class="hud-chip-row">
        <span class="hud-chip" id="hudQos">LOD 100% · High</span>
        <span class="hud-chip" id="hudEuler">--</span>
      </div>

      <div class="hud-info-grid">
        <div class="hud-info-item">
          <span class="hud-info-label">Tiles</span>
          <span class="hud-info-value mono" id="hudDetailTiles">—</span>
        </div>
        <div class="hud-info-item">
          <span class="hud-info-label">Build</span>
          <span class="hud-info-value mono" id="hudDetailBuild">—</span>
        </div>
        <div class="hud-info-item">
          <span class="hud-info-label">Radius</span>
          <span class="hud-info-value mono" id="hudDetailRadius">—</span>
        </div>
      </div>

      <div class="hud-actions">
        <button id="hudGpsReckon" type="button" class="hud-button" aria-pressed="false" title="Toggle GPS lock">GPS</button>
        <button id="hudDebugToggle" type="button" class="hud-button" aria-pressed="false" title="Toggle debug overlay">Debug</button>
        <button id="hudReset" type="button" class="hud-button" title="Clear caches and reload">Reset</button>
        <button id="menuBtn" type="button" class="hud-button" title="Opens control panel">Controls</button>
      </div>

      <div class="hud-userlist-footer">
        <button id="hudUsersToggle" type="button" aria-expanded="false">Users ▸</button>
        <div id="hudUserPanel" class="hud-user-panel" hidden>
          <div id="hudUserList" class="hud-user-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="miniMapDock">
    <div class="mini-map-shell">
      <div id="miniMapMap" class="mini-map-panel mini-map-canvas" aria-label="Mini map preview"></div>
      <div class="mini-map-overlay" aria-live="polite">
        <div class="mini-map-coords">
          <div class="mini-map-field">
            <span class="mini-map-label">Geohash</span>
            <span class="mini-map-value mono" id="hudGeohash">--</span>
          </div>
          <div class="mini-map-field">
            <span class="mini-map-label">Lat</span>
            <span class="mini-map-value mono" id="hudLat">--</span>
          </div>
          <div class="mini-map-field">
            <span class="mini-map-label">Lon</span>
            <span class="mini-map-value mono" id="hudLon">--</span>
          </div>
          <div class="mini-map-field">
            <span class="mini-map-label">Alt</span>
            <span class="mini-map-value mono" id="hudAltitude">--</span>
          </div>
        </div>
        <div class="mini-map-actions" aria-label="Mini map actions">
          <button id="miniMapMove" type="button" class="mini-map-button" aria-label="Teleport to selected mini map location">Move</button>
          <button id="miniMapSnap" type="button" class="mini-map-button" aria-label="Snap view to device compass heading">Snap</button>
        </div>
        <div class="mini-map-status tiny" id="miniMapStatus">Determining location…</div>
      </div>
    </div>
  </div>

  <!-- Modal overlay -->
  <div id="backdrop" aria-hidden="true"></div>
  <div id="menuPane" aria-label="World Control Center">
    <div class="wrapper">
    <header class="modal-header">
      <h2>Control Center</h2>
      <button id="closeButton" type="button" aria-label="Close Control Center">&times;</button>
    </header>

    <div class="control-tabs" id="controlTabs">
      <div class="control-tablist" role="tablist" aria-label="Control center sections">
        <button class="control-tab is-active" role="tab" aria-selected="true" aria-controls="tab-overview" data-tab="overview">Overview</button>
        <button class="control-tab" role="tab" aria-selected="false" aria-controls="tab-navigation" data-tab="navigation">Navigation</button>
        <button class="control-tab" role="tab" aria-selected="false" aria-controls="tab-networking" data-tab="networking">Networking</button>
        <button class="control-tab" role="tab" aria-selected="false" aria-controls="tab-character" data-tab="character">Character</button>
        <button class="control-tab" role="tab" aria-selected="false" aria-controls="tab-environment" data-tab="environment">Environment</button>
        <button class="control-tab" role="tab" aria-selected="false" aria-controls="tab-diagnostics" data-tab="diagnostics">Diagnostics</button>
      </div>
      <div class="control-tabpanels">
        <div class="tab-panel is-active" id="tab-overview" role="tabpanel" data-tab-panel="overview">
          <section class="modal-section">
            <h3 class="section-title">Network</h3>
            <div class="status-grid">
              <span class="kv"><span class="dot" id="dotNkn"></span><b id="txtNkn">NKN: connecting…</b></span>
              <span class="kv"><span class="dot" id="dotSig"></span><b id="txtSig">Mesh: discovering…</b></span>
            </div>
            <div class="tiny" id="txtSigMeta">—</div>
            <div class="kv">addr: <span class="mono" id="myAddr">—</span></div>
            <div class="kv">pub: <span class="mono" id="myPub">—</span></div>
            <label for="displayNameInput">Display name</label>
            <div class="input-row">
              <input id="displayNameInput" type="text" maxlength="24" autocomplete="off" spellcheck="false" placeholder="Choose how others see you" />
              <button id="displayNameSave" type="button">Save</button>
            </div>
            <p class="tiny">Pick a short prefix shown to other players instead of your full NKN address.</p>
            <div class="kv">terrain: <span class="mono" id="terrainRelayStatus">idle</span></div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Device</h3>
            <div class="kv"><span class="tiny">Browser</span>&nbsp;<span id="overviewBrowser" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Platform</span>&nbsp;<span id="overviewPlatform" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Resolution</span>&nbsp;<span id="overviewResolution" class="mono">—</span></div>
            <div class="kv"><span class="tiny">User Agent</span>&nbsp;<span id="overviewUserAgent" class="mono">—</span></div>
          </section>
        </div>

        <div class="tab-panel" id="tab-navigation" role="tabpanel" data-tab-panel="navigation" hidden>
          <section class="modal-section">
            <h3 class="section-title">Terrain Relay</h3>
            <label for="terrainRelayInput">Relay address</label>
            <input id="terrainRelayInput" type="text" class="mono" spellcheck="false" placeholder="forwarder.… or pubkey" />
            <label for="terrainDatasetInput">Dataset</label>
            <input id="terrainDatasetInput" type="text" value="mapzen" />
            <div class="choice-row" role="radiogroup" aria-label="Terrain query mode">
              <label><input type="radio" name="terrainMode" id="terrainModeGeohash" value="geohash" checked /> Geohash</label>
              <label><input type="radio" name="terrainMode" id="terrainModeLatLng" value="latlng" /> Lat/Lng</label>
            </div>
            <p class="modal-note">Override the relay or dataset used for terrain sampling. Updates apply to new tiles immediately.</p>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Navigation &amp; Sensors</h3>
            <div class="button-row">
              <button id="request" type="button">Enable Sensors</button>
              <button id="geo" type="button">Enable Geolocation</button>
            </div>
            <div class="mini-map-controls">
              <button id="miniMapRecenter" type="button">Follow: On</button>
              <button id="miniMapSet" type="button">Set Location</button>
              <button id="yawAssistToggle" type="button">Yaw Corr: On</button>
            </div>
            <div class="slider-row">
              <label for="yawOffsetRange">Yaw Offset <span id="yawOffsetValue">0°</span></label>
              <input id="yawOffsetRange" type="range" min="-180" max="180" value="0" step="1" />
            </div>
            <label class="toggle-row" for="gpsLockToggle">
              <input id="gpsLockToggle" type="checkbox" checked />
              <span class="toggle-text">
                <span class="toggle-title">Lock world to GPS</span>
                <span class="tiny">Phones follow your live position. Desktop users can turn this off after enabling geolocation.</span>
              </span>
            </label>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Location</h3>
            <div class="mini-map-manual">
              <input id="miniMapLat" type="text" class="mono" placeholder="Manual lat" spellcheck="false" />
              <input id="miniMapLon" type="text" class="mono" placeholder="Manual lon" spellcheck="false" />
              <button id="miniMapApply" type="button">Apply Manual</button>
            </div>
            <div id="miniMapStatus" class="tiny">Determining location…</div>
          </section>
        </div>

        <div class="tab-panel" id="tab-networking" role="tabpanel" data-tab-panel="networking" hidden>
          <section class="modal-section">
            <h3 class="section-title">Pose TX</h3>
            <div class="row">
              <span class="kv">Hz: <b id="poseHz">0</b></span>
              <span class="kv">Sent: <b id="poseSent">0</b></span>
              <span class="kv">Dropped: <b id="poseDrop">0</b></span>
              <span class="kv">Rate: <b id="poseRate">0.0</b> <span class="tiny">kbps</span></span>
            </div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Peers</h3>
            <div class="tiny" id="peerSummary">—</div>
            <div id="peerList" class="peer-list"></div>
          </section>
        </div>

        <div class="tab-panel" id="tab-character" role="tabpanel" data-tab-panel="character" hidden>
          <section class="modal-section">
            <h3 class="section-title">Local Pose</h3>
            <div class="kv"><span class="tiny">pos:</span>&nbsp;<span id="lpPos" class="mono">—</span></div>
            <div class="kv"><span class="tiny">euler°:</span>&nbsp;<span id="lpEul" class="mono">—</span></div>
            <div class="kv"><span class="tiny">speed:</span>&nbsp;<span id="lpSpd" class="mono">—</span></div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Model Diagnostics</h3>
            <div class="kv"><span class="tiny">Animation</span>&nbsp;<span id="charAnimState" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Speed</span>&nbsp;<span id="charSpeedValue" class="mono">0.00 m/s</span></div>
            <div class="kv"><span class="tiny">Elevation</span>&nbsp;<span id="charElevationValue" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Eye Height</span>&nbsp;<span id="charEyeHeightValue" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Crouch</span>&nbsp;<span id="charCrouchState" class="mono">—</span></div>
            <div class="kv"><span class="tiny">Jump</span>&nbsp;<span id="charJumpState" class="mono">—</span></div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Sign Flips</h3>
            <p class="tiny">Invert axes on the fly to debug mismatched input devices.</p>
            <label class="toggle-row" for="charFlipForward">
              <input id="charFlipForward" type="checkbox">
              <span class="toggle-text">
                <span class="toggle-title">Invert Forward/Back</span>
                <span class="tiny">Applies to keyboard, mobile, and VR forward motion.</span>
              </span>
            </label>
            <label class="toggle-row" for="charFlipStrafe">
              <input id="charFlipStrafe" type="checkbox">
              <span class="toggle-text">
                <span class="toggle-title">Invert Strafe</span>
                <span class="tiny">Flips left/right movement inputs.</span>
              </span>
            </label>
            <label class="toggle-row" for="charFlipYaw">
              <input id="charFlipYaw" type="checkbox">
              <span class="toggle-text">
                <span class="toggle-title">Invert Yaw</span>
                <span class="tiny">Reverses yaw input for touch and VR controllers.</span>
              </span>
            </label>
          </section>
        </div>

        <div class="tab-panel" id="tab-environment" role="tabpanel" data-tab-panel="environment" hidden>
          <section class="modal-section">
            <h3 class="section-title">Terrain LOD</h3>
            <div class="slider-row">
              <label for="envInteractiveRing">Interactive Ring <span class="mono" id="envInteractiveRingValue">4</span> <span class="tiny env-current" id="envInteractiveRingCurrent">(engine: 4)</span></label>
              <input id="envInteractiveRing" type="range" min="1" max="10" step="1" value="4" />
            </div>
            <div class="slider-row">
              <label for="envVisualRing">Visual Ring <span class="mono" id="envVisualRingValue">8</span> <span class="tiny env-current" id="envVisualRingCurrent">(engine: 8)</span></label>
              <input id="envVisualRing" type="range" min="2" max="18" step="1" value="8" />
            </div>
            <div class="slider-row">
              <label for="envFarfieldExtra">Farfield Extension <span class="mono" id="envFarfieldExtraValue">60</span> <span class="tiny env-current" id="envFarfieldExtraCurrent">(engine: 60)</span></label>
              <input id="envFarfieldExtra" type="range" min="1" max="120" step="1" value="60" />
            </div>
            <div class="slider-row">
              <label for="envFarfieldNearPad">Near Seam Padding <span class="mono" id="envFarfieldNearPadValue">6</span> <span class="tiny env-current" id="envFarfieldNearPadCurrent">(engine: 6)</span></label>
              <input id="envFarfieldNearPad" type="range" min="0" max="24" step="1" value="6" />
            </div>
            <div class="slider-row">
              <label for="envFarfieldBudget">Farfield Create Budget <span class="mono" id="envFarfieldBudgetValue">60</span> <span class="tiny env-current" id="envFarfieldBudgetCurrent">(engine: 60)</span></label>
              <input id="envFarfieldBudget" type="range" min="5" max="160" step="5" value="60" />
            </div>
            <div class="slider-row">
              <label for="envFarfieldBatch">Farfield Batch Size <span class="mono" id="envFarfieldBatchValue">48</span> <span class="tiny env-current" id="envFarfieldBatchCurrent">(engine: 48)</span></label>
              <input id="envFarfieldBatch" type="range" min="8" max="128" step="4" value="48" />
            </div>
            <div class="slider-row">
              <label for="envTileRadius">Tile Radius <span class="mono" id="envTileRadiusValue">100 m</span> <span class="tiny env-current" id="envTileRadiusCurrent">(engine: 100 m)</span></label>
              <input id="envTileRadius" type="range" min="60" max="180" step="5" value="100" />
            </div>
            <div class="button-row">
              <button id="envTerrainApply" type="button">Update Terrain</button>
              <button id="envTerrainAuto" type="button" data-state="on">Auto (On)</button>
            </div>
            <div class="slider-row">
              <label for="envTerrainTargetFps">Target FPS <span class="mono" id="envTerrainTargetFpsValue">60 fps</span></label>
              <input id="envTerrainTargetFps" type="range" min="0" max="60" step="1" value="60" />
            </div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Buildings</h3>
            <div class="slider-row">
              <label for="envBuildingRadius">Building Radius <span class="mono" id="envBuildingRadiusValue">3000 m</span> <span class="tiny env-current" id="envBuildingRadiusCurrent">(engine: 3000 m)</span></label>
              <input id="envBuildingRadius" type="range" min="400" max="8000" step="100" value="3000" />
            </div>
            <div class="button-row">
              <button id="envBuildingApply" type="button">Update Buildings</button>
              <button id="envBuildingAuto" type="button" data-state="on">Auto (On)</button>
            </div>
            <div class="slider-row">
              <label for="envBuildingTargetFps">Target FPS <span class="mono" id="envBuildingTargetFpsValue">60 fps</span></label>
              <input id="envBuildingTargetFps" type="range" min="0" max="60" step="1" value="60" />
            </div>
          </section>
        </div>

        <div class="tab-panel" id="tab-diagnostics" role="tabpanel" data-tab-panel="diagnostics" hidden>
          <section class="modal-section">
            <h3 class="section-title">Wallet</h3>
            <button id="nuke" title="Hard reset identity &amp; caches">
              <span class="sub">NUKE CREDENTIALS — hard reset identity &amp; caches</span>
            </button>
            <div class="modal-note">Generates a new NKN seed and clears caches. You will appear as a fresh peer.</div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">Adaptive Quality</h3>
            <div class="kv"><span class="tiny">Target FPS</span>&nbsp;<span id="diagPidTargetFps" class="mono">60</span></div>
            <div class="kv"><span class="tiny">Smoothed FPS</span>&nbsp;<span id="diagPidSmoothedFps" class="mono">60.0</span></div>
            <div class="kv"><span class="tiny">Error</span>&nbsp;<span id="diagPidError" class="mono">0.00</span></div>
            <div class="kv"><span class="tiny">Integral</span>&nbsp;<span id="diagPidIntegral" class="mono">0.00</span></div>
            <div class="kv"><span class="tiny">Derivative</span>&nbsp;<span id="diagPidDerivative" class="mono">0.00</span></div>
            <div class="kv"><span class="tiny">Quality</span>&nbsp;<span id="diagPidQuality" class="mono">1.00</span></div>
          </section>

          <section class="modal-section">
            <h3 class="section-title">PID Tuning</h3>
            <div class="pid-grid">
              <label class="pid-cell">k_p<input id="diagPidKp" type="number" step="0.001" min="0" /></label>
              <label class="pid-cell">k_i<input id="diagPidKi" type="number" step="0.001" min="0" /></label>
              <label class="pid-cell">k_d<input id="diagPidKd" type="number" step="0.001" min="0" /></label>
              <label class="pid-cell">Gain<input id="diagPidGain" type="number" step="0.01" min="0" /></label>
              <label class="pid-cell">Deadband<input id="diagPidDeadband" type="number" step="0.1" min="0" /></label>
              <label class="pid-cell">Smoothing<input id="diagPidSmoothing" type="number" step="0.01" min="0.01" /></label>
            </div>
            <div class="button-row">
              <button id="diagPidApply" type="button">Apply Gains</button>
              <button id="diagPidReset" type="button">Reset Integrator</button>
            </div>
          </section>

          <section class="modal-section debug-only" id="processLeaderboardSection">
            <h3 class="section-title">Process Leaderboard</h3>
            <div id="processLeaderboard" class="process-leaderboard">
              <div class="process-header">
                <div class="tiny">Sorted by average latency</div>
                <button id="processReset" type="button" class="process-reset" title="Clear collected metrics">Reset Metrics</button>
              </div>
              <div id="processCards" class="process-cards"></div>
              <canvas id="processGraph" width="480" height="240" aria-label="Process metrics over time"></canvas>
              <div id="processEmptyState" class="process-empty tiny">Metrics will appear after debug mode collects activity.</div>
            </div>
          </section>
        </div>
      </div>
    </div>
    </div>
  </div>

  <div id="nameModal" aria-hidden="true">
    <div class="name-modal-shell">
      <h2>Choose a display name</h2>
      <p>This name will appear above your avatar and for other players. You can change it later from the control center.</p>
      <input id="nameModalInput" type="text" maxlength="24" autocomplete="off" spellcheck="false" placeholder="Enter a short name" />
      <div class="name-modal-actions">
        <button id="nameModalSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Entry points -->
  <script type="module" src="./js/app.js"></script>
  <script type="module" src="./js/persist.js"></script>

</body>

</html>
