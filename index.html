<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
<!-- Default (desktop and everything else) -->
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- Mobile override (where supported) -->
<meta name="viewport"
      media="(max-width: 768px)"
      content="width=device-width, initial-scale=0.5, maximum-scale=0.5, user-scalable=no">

  <title>NOCLIP - NKN Powered Telepresence</title>
  <link rel="stylesheet" href="style.css">

  <!-- NKN SDK (global window.nkn) -->
  <script src="https://unpkg.com/nkn-sdk@1.3.6/dist/nkn.min.js"></script>

  <!-- Leaflet for minimap -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    (function () {
      function checkAndRemove() {
        var el = document.getElementById('VRButton');
        if (!el) return false;

        var txt = (el.textContent || "").trim().toUpperCase();
        if (txt === "VR NOT AVAILABLE" || txt.includes("VR NOT AVAILABLE") || txt === "VR NOT SUPPORTED" || txt.includes("VR NOT SUPPORTED") || txt === "WEBXR NOT AVAILABLE" || txt.includes("WEBXR NOT AVAILABLE")) {
          //el.remove();
          return true;
        }
        return false;
      }

      // Run now or on DOM ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", checkAndRemove, { once: true });
      } else {
        checkAndRemove();
      }

      // Catch late-inserted buttons
      var mo = new MutationObserver(function (_, obs) {
        if (checkAndRemove()) obs.disconnect();
      });
      mo.observe(document.documentElement || document.body, { childList: true, subtree: true });
    })();
  </script>
  <!-- three.js import map -->
  <script type="importmap">
    {
      "imports": {
        "three"   : "https://cdn.jsdelivr.net/npm/three@0.177.0/build/three.module.min.js",
        "VRButton": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/VRButton.js",
        "XRControllerModelFactory": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/webxr/XRControllerModelFactory.js",
        "PointerLockControls": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/controls/PointerLockControls.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.177.0/examples/jsm/",
        "nats.ws": "https://cdn.jsdelivr.net/npm/nats.ws@1.29.2/esm/nats.js"
      }
    }
  </script>
</head>

<body>
  <div id="toastHost" aria-live="polite" aria-atomic="false"></div>
  <div id="perfHud" aria-live="polite" aria-expanded="false" role="button" tabindex="0" title="Open control center">
    <div class="hud-shell" id="hudDetail">
      <div class="hud-heading-row">
        <div class="hud-compass" aria-hidden="true">
          <span class="hud-compass-needle" id="hudCompassNeedle"></span>
        </div>
        <div class="hud-heading-block">
          <span class="hud-heading-label">Heading</span>
          <span class="hud-heading" id="hudHeadingText">--°</span>
        </div>
        <div class="hud-fps-block">
          <span class="hud-block-label">FPS</span>
          <span class="hud-block-value" id="hudFps">60</span>
        </div>
      </div>

      <div class="hud-status-stack">
        <div class="hud-status-item" id="hudStatusNkn">
          <span class="hud-status-dot dot" id="hudStatusNknDot" aria-hidden="true"></span>
          <span class="hud-status-label" id="hudStatusNknLabel">NKN</span>
        </div>
        <div class="hud-status-item" id="hudStatusTerrain">
          <span class="hud-status-dot dot" id="hudStatusTerrainDot" aria-hidden="true"></span>
          <span class="hud-status-label" id="hudStatusTerrainLabel">Terrain</span>
        </div>
        <div class="hud-status-item" id="hudStatusSignal">
          <span class="hud-status-dot dot" id="hudStatusSigDot" aria-hidden="true"></span>
          <span class="hud-status-label" id="hudStatusSigLabel">Signal</span>
        </div>
      </div>

      <div class="hud-block">
        <span class="hud-block-label">Peers online</span>
        <span class="hud-block-value" id="hudPeerCount">0</span>
      </div>

      <div class="hud-metric-grid">
        <div class="hud-metric">
          <span class="hud-block-label">LOD</span>
          <span class="hud-qos" id="hudQos">LOD 100% · High</span>
        </div>
        <div class="hud-metric">
          <span class="hud-block-label">Tiles</span>
          <span class="hud-block-value" id="hudDetailTiles">—</span>
        </div>
        <div class="hud-metric">
          <span class="hud-block-label">Build</span>
          <span class="hud-block-value" id="hudDetailBuild">—</span>
        </div>
        <div class="hud-metric">
          <span class="hud-block-label">Radius</span>
          <span class="hud-block-value" id="hudDetailRadius">—</span>
        </div>
      </div>
      <div class="hud-block">
        <span class="hud-block-label">Orientation</span>
        <span class="hud-block-value" id="hudEuler">--</span>
      </div>
    </div>
  </div>
  <div id="miniMapDock">
    <div id="miniMapMap" class="mini-map-panel" aria-label="Mini map preview"></div>
    <div class="mini-map-action-stack" aria-label="Mini map actions">
      <button id="miniMapMove" type="button" aria-label="Teleport to selected mini map location">Move</button>
      <button id="miniMapSnap" type="button" aria-label="Snap view to device compass heading">Snap</button>
    </div>
    <div class="mini-map-info" aria-live="polite">
      <div class="mini-map-info-row">
        <span class="mini-map-info-label">Geohash</span>
        <span class="mini-map-info-value" id="hudGeohash">--</span>
      </div>
      <div class="mini-map-info-row">
        <span class="mini-map-info-label">Lat</span>
        <span class="mini-map-info-value" id="hudLat">--</span>
      </div>
      <div class="mini-map-info-row">
        <span class="mini-map-info-label">Lon</span>
        <span class="mini-map-info-value" id="hudLon">--</span>
      </div>
      <div class="mini-map-info-row">
        <span class="mini-map-info-label">Alt</span>
        <span class="mini-map-info-value" id="hudAltitude">--</span>
      </div>
    </div>
  </div>

  <!-- Modal overlay -->
  <div id="backdrop" aria-hidden="true"></div>
  <div id="menuPane" aria-label="World Control Center">
    <div class="wrapper">
    <header class="modal-header">
      <h2>Control Center</h2>
      <button id="closeButton" type="button" aria-label="Close Control Center">&times;</button>
    </header>

    <section class="modal-section">
      <h3 class="section-title">Network</h3>
      <div class="status-grid">
        <span class="kv"><span class="dot" id="dotNkn"></span><b id="txtNkn">NKN: connecting…</b></span>
        <span class="kv"><span class="dot" id="dotSig"></span><b id="txtSig">Mesh: discovering…</b></span>
      </div>
      <div class="tiny" id="txtSigMeta">—</div>
      <div class="kv">addr: <span class="mono" id="myAddr">—</span></div>
      <div class="kv">pub: <span class="mono" id="myPub">—</span></div>
      <label for="displayNameInput">Display name</label>
      <div class="input-row">
        <input id="displayNameInput" type="text" maxlength="24" autocomplete="off" spellcheck="false" placeholder="Choose how others see you" />
        <button id="displayNameSave" type="button">Save</button>
      </div>
      <p class="tiny">Pick a short prefix shown to other players instead of your full NKN address.</p>
      <div class="kv">terrain: <span class="mono" id="terrainRelayStatus">idle</span></div>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Terrain Relay</h3>
      <label for="terrainRelayInput">Relay address</label>
      <input id="terrainRelayInput" type="text" class="mono" spellcheck="false" placeholder="forwarder.… or pubkey" />
      <label for="terrainDatasetInput">Dataset</label>
      <input id="terrainDatasetInput" type="text" value="mapzen" />
      <div class="choice-row" role="radiogroup" aria-label="Terrain query mode">
        <label><input type="radio" name="terrainMode" id="terrainModeGeohash" value="geohash" checked /> Geohash</label>
        <label><input type="radio" name="terrainMode" id="terrainModeLatLng" value="latlng" /> Lat/Lng</label>
      </div>
      <p class="modal-note">Override the relay or dataset used for terrain sampling. Updates apply to new tiles immediately.</p>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Navigation &amp; Sensors</h3>
      <div class="button-row">
        <button id="request" type="button">Enable Sensors</button>
        <button id="geo" type="button">Enable Geolocation</button>
      </div>
      <div class="mini-map-controls">
        <button id="miniMapRecenter" type="button">Follow: On</button>
        <button id="miniMapSet" type="button">Set Location</button>
        <button id="yawAssistToggle" type="button">Yaw Corr: On</button>
      </div>
      <div class="slider-row">
        <label for="yawOffsetRange">Yaw Offset <span id="yawOffsetValue">0°</span></label>
        <input id="yawOffsetRange" type="range" min="-180" max="180" value="0" step="1" />
      </div>
      <label class="toggle-row" for="gpsLockToggle">
        <input id="gpsLockToggle" type="checkbox" checked />
        <span class="toggle-text">
          <span class="toggle-title">Lock world to GPS</span>
          <span class="tiny">Phones follow your live position. Desktop users can turn this off after enabling geolocation.</span>
        </span>
      </label>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Location</h3>
      <div class="mini-map-manual">
        <input id="miniMapLat" type="text" class="mono" placeholder="Manual lat" spellcheck="false" />
        <input id="miniMapLon" type="text" class="mono" placeholder="Manual lon" spellcheck="false" />
        <button id="miniMapApply" type="button">Apply Manual</button>
      </div>
      <div id="miniMapStatus" class="tiny">Determining location…</div>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Pose TX</h3>
      <div class="row">
        <span class="kv">Hz: <b id="poseHz">0</b></span>
        <span class="kv">Sent: <b id="poseSent">0</b></span>
        <span class="kv">Dropped: <b id="poseDrop">0</b></span>
        <span class="kv">Rate: <b id="poseRate">0.0</b> <span class="tiny">kbps</span></span>
      </div>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Local Pose</h3>
      <div class="kv"><span class="tiny">pos:</span>&nbsp;<span id="lpPos" class="mono">—</span></div>
      <div class="kv"><span class="tiny">euler°:</span>&nbsp;<span id="lpEul" class="mono">—</span></div>
      <div class="kv"><span class="tiny">speed:</span>&nbsp;<span id="lpSpd" class="mono">—</span></div>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Wallet</h3>
      <button id="nuke" title="Hard reset identity & caches">
        <span class="sub">NUKE CREDENTIALS — hard reset identity & caches</span>
      </button>
      <div class="modal-note">Generates a new NKN seed and clears caches. You will appear as a fresh peer.</div>
    </section>

    <section class="modal-section">
      <h3 class="section-title">Peers</h3>
      <div class="tiny" id="peerSummary">—</div>
      <div id="peerList" class="peer-list"></div>
    </section>
    </div>
  </div>

  <div id="nameModal" aria-hidden="true">
    <div class="name-modal-shell">
      <h2>Choose a display name</h2>
      <p>This name will appear above your avatar and for other players. You can change it later from the control center.</p>
      <input id="nameModalInput" type="text" maxlength="24" autocomplete="off" spellcheck="false" placeholder="Enter a short name" />
      <div class="name-modal-actions">
        <button id="nameModalSave" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Entry points -->
  <script type="module" src="./js/app.js"></script>
  <script type="module" src="./js/persist.js"></script>

</body>

</html>
